## Setup

### Data directories

The output of the main simulation file, `run-simulations.R`, can be quite large. We made a separate directory to house these output files: "/projects/academic/naokimas/neil/early-warning-theory/". We recommend that you change this directory to your preferred data directory, replacing it wherever it appears. The `./data` directory has a single file, `networks.rda`, with the networks we used in our analysis; it is also a place to put other data files generated by the code. Figures will be placed in `./img` by default.

### Dependencies

We conducted all simulations on a high-performance computing cluster running Gentoo Linux, the [Lmod software environment system](https://lmod.readthedocs.io/en/latest/index.html), and the [Slurm workload manager](https://slurm.schedmd.com/overview.html). We used Bash for all shell scripts. R scripts depend on [igraph](https://cran.r-project.org/package=igraph), [arrangements](https://cran.r-project.org/package=arrangements), parallel (see the base R [documentation](https://cran.r-project.org/doc/manuals/r-release/fullrefman.pdf)), [optparse](https://cran.r-project.org/package=optparse), and [latex2exp](https://cran.r-project.org/package=latex2exp) and [sfsmisc](https://cran.r-project.org/package=sfsmisc) for plotting. 

The files `calc-functions.R`, `plot-functions.R`, and `sim-functions.R` are used by simulation and analysis files (via `source()`) and should stay in the base directory (`./simulations` or your working directory).

## Random number generation

We use the L'Ecuyer CMRG that ships with R and is recommended for parallel processing. We also set the random number state in several different files (e.g., `set.seed(1248)` in `run-simulations.R`). That said, running these simulations with a different number of available CPUs (or other differences from our compute cluster) may yield different results even with the same random seed.

## Procedure

Most `.R` files in this directory can be run interactively or with a Bash script. If running interactively, we recommend that you evaluate the `library(optparse); optionlist <-` and `args <-` blocks first. The `args` object is a named list that stores various options; these can be adjusted by using e.g. `args$network <- "fitness"`. Defaults and available options are listed in `optionlist`.

To run a `.R` file from the command line, use `Rscript` and set options using command line arguments. An example is
```sh
Rscript run-simulations.R --network=fitness
```
which will generate three independent simulations of the double-well dynamics on the stored node fitness network. To see defaults and options in the terminal, use e.g. `Rscript run-simulations.R -h`.

To run large numbers of simulations, or simulations on larger networks, we recommend using a larger number of cores, e.g. on a compute cluster. As such, we include several shell scripts that request resources from a compute cluster using Slurm. For example, to run all of our base simulations (i.e., that produce the time series on which our other analyses depend), we use the command
```sh
sbatch run-all-simulations.sh
```
which, as currently written, requests up to six hours of time on the cluster with one compute node, 26 CPUs (cores), etc. and generate 50 independent simulations each of a variety of conditions.

To make all files needed for the figures in the manuscript, run the following commands:

- sbatch run-all-simulations.sh (calls run-simulations.R); must be complete before running anything else
- sbatch analyze-all-results.sh (calls reporting.R)
- sbatch summary-fig.sh (calls summary-fig.R)
- bash run-all-osumfigs.sh, which will call sbatch overall-summary-fig.sh for the appropriate k1/k2 combinations. 
- sbatch tau-tau-scatter-data.sh
- bash run-remaining-figs.sh (tau-tau-scatter.R, tau-tau-scatter-highlowinput.R, overall-summary-fig-alt.R)

## Other adjustments

Other minor adjustments may be needed to run these files. If you have any questions please contact neil.g.maclaren at gmail.com. 
